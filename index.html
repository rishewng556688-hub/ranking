<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å¥–åŠ±æ’åç³»ç»Ÿ</title>

<style>
:root{
  --bg:#f4f6f9; --card:#ffffff; --primary:#2563eb;
  --danger:#dc2626; --border:#e5e7eb;
  --text:#1f2937; --muted:#6b7280;
}
body.dark{
  --bg:#0f172a; --card:#020617; --text:#e5e7eb;
  --muted:#94a3b8; --border:#1e293b; --primary:#38bdf8;
}
body{
  margin:0;padding:30px;background:var(--bg);
  font-family:"Segoe UI","PingFang SC","Microsoft YaHei",sans-serif;
  color:var(--text);
}
h2{text-align:center;margin-bottom:20px;}
.card{
  max-width:1200px;margin:auto;background:var(--card);
  border-radius:14px;padding:20px;
  box-shadow:0 6px 18px rgba(0,0,0,.05);
  position:relative;
}
.controls{display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:15px;}
.controls-left{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
select,input,button{
  padding:6px 10px;border-radius:8px;
  border:1px solid var(--border);
}
button{cursor:pointer;border:none;}
.btn-primary{background:var(--primary);color:#fff;}
.btn-secondary{background:#e5e7eb;}
.btn-danger{background:#fee2e2;color:#b91c1c;}

table{width:100%;border-collapse:collapse;}
thead th{
  position:sticky;top:0;background:#f9fafb;
  color:var(--muted);font-weight:500;
}
tbody tr:hover{background:#f9fafb;}
th,td{
  padding:10px 12px;
  border-bottom:1px solid var(--border);
  text-align:center;
  white-space:nowrap;
}

.rank{font-weight:700;font-size:16px;}
.top1 .rank::before{content:"ğŸ¥‡ ";}
.top2 .rank::before{content:"ğŸ¥ˆ ";}
.top3 .rank::before{content:"ğŸ¥‰ ";}
.top4 .rank::before,
.top5 .rank::before{content:"â­ ";}

.top1{background:linear-gradient(90deg,#fff7cc,#fff);}
.top2{background:linear-gradient(90deg,#f1f5f9,#fff);}
.top3{background:linear-gradient(90deg,#fef3c7,#fff);}
.top4,.top5{background:linear-gradient(90deg,#eef2ff,#fff);}

.input-cell{
  width:100%;
  border:none;
  text-align:center;
  background:transparent;
  font:inherit;
}

.delta.up{color:#16a34a;font-weight:bold;}
.delta.down{color:#dc2626;font-weight:bold;}
.delta.same{color:#6b7280;}

.performance input.pos{color:#16a34a;font-weight:700;}
.performance input.neg{color:#dc2626;font-weight:700;}

.hide{display:none;}
.action-btn{display:none;}

.watermark{
  position:absolute;
  right:20px;
  bottom:10px;
  font-size:12px;
  color:#9ca3af;
  opacity:.85;
  display:none;
}
</style>
</head>

<body>

<h2>ğŸ† å¥–åŠ±æ’åç³»ç»Ÿ / Reward Ranking System</h2>

<div class="card" id="captureArea">

  <div class="controls" id="controlPanel">
    <div class="controls-left">
      æ’åä¾æ®ï¼š
      <select id="rankType" onchange="updateRanking();updateRewards();saveData();">
        <option value="performance">ä¸šç»© / Total Money</option>
        <option value="push">æ¨é€ / Clients Push</option>
        <option value="first">é¦–å­˜ / First Deposit</option>
      </select>

      å¥–åŠ±æ¨¡å¼ï¼š
      <select id="rewardMode" onchange="updateRewards();saveData();">
        <option value="manual">æ‰‹åŠ¨ / Manual</option>
        <option value="percent">æŒ‰ä¸šç»©% / Percent</option>
      </select>

      ç™¾åˆ†æ¯”ï¼š
      <input id="rewardPercent" type="number" value="5" style="width:60px"> %

      å¥–åŠ±å‰
      <input id="rewardTopN" type="number" value="3" min="1" style="width:60px"> å
    </div>

    <div>
      <button class="btn-secondary" onclick="unlockEdit()">ğŸ”“ ç¼–è¾‘</button>
      <button class="btn-primary" id="lockBtn" onclick="lockEdit()" style="display:none;">ğŸ”’ é”å®š</button>
      <button class="btn-primary" onclick="addPerson()">â• æ·»åŠ </button>
      <button class="btn-primary" onclick="toggleView()">ğŸ‘ å±•ç¤º</button>
      <button class="btn-primary" onclick="toggleDark()">ğŸŒ™ å¤œé—´</button>
      <button class="btn-primary" onclick="capturePage()">ğŸ“¸ æˆªå›¾</button>
      <button class="btn-primary" onclick="captureAll()">ğŸ“¸ å¯¼å‡ºä¸‰æ¦œ</button>
    </div>
  </div>

  <table id="rankingTable">
    <thead>
      <tr>
        <th>æ’å<br><small>Ranking</small></th>
        <th>å˜åŒ–<br><small>Delta</small></th>
        <th>å§“å<br><small>Name</small></th>
        <th>æ¨é€<br><small>Clients Push</small></th>
        <th>é¦–å­˜<br><small>First Deposit</small></th>
        <th>ä¸šç»©<br><small>Total Money</small></th>
        <th>å¥–åŠ±<br><small>Reward</small></th>
        <th>æ“ä½œ<br><small>Action</small></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="watermark" id="watermark">
    CPT MARKETS Â· <span id="wmDate"></span>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
const STORAGE_KEY="ranking_system_data";
const LAST_KEY="ranking_system_yesterday";
let isUnlocked=false;
let isCapturing=false;

const defaultData=[
 {name:"å¼ ä¸‰",push:120,first:50,performance:300,reward:0},
 {name:"æå››",push:90,first:40,performance:-120,reward:0},
 {name:"ç‹äº”",push:80,first:35,performance:200,reward:0},
 {name:"èµµå…­",push:70,first:30,performance:180,reward:0},
 {name:"å­™ä¸ƒ",push:60,first:25,performance:160,reward:0}
];

function loadData(){
 return JSON.parse(localStorage.getItem(STORAGE_KEY))||defaultData;
}

function saveData(){
 const data=[];
 document.querySelectorAll("tbody tr").forEach(r=>{
  data.push({
   name:r.querySelector(".name input").value,
   push:+r.querySelector(".push input").value,
   first:+r.querySelector(".first input").value,
   performance:+r.querySelector(".performance input").value,
   reward:+r.querySelector(".reward input").value
  });
 });
 localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
}

function renderTable(data){
 const tbody=document.querySelector("tbody");
 tbody.innerHTML="";
 data.forEach(d=>{
  const tr=tbody.insertRow();
  tr.innerHTML=`
   <td></td>
   <td class="delta"></td>
   <td class="name"><input class="input-cell" value="${d.name}" readonly></td>
   <td class="push"><input class="input-cell" type="number" value="${d.push}" readonly></td>
   <td class="first"><input class="input-cell" type="number" value="${d.first}" readonly></td>
   <td class="performance"><input class="input-cell" type="number" value="${d.performance}" readonly></td>
   <td class="reward"><input class="input-cell" type="number" value="${d.reward}" readonly></td>
   <td><button class="btn-danger action-btn" onclick="deleteRow(this)">åˆ é™¤</button></td>
  `;
 });
 updateRanking();
 updateRewards();
}

function updateRanking(){
 const tbody=document.querySelector("tbody");
 const rows=[...tbody.rows];
 const type=rankType.value;
 const yesterday=JSON.parse(localStorage.getItem(LAST_KEY)||"[]");

 rows.sort((a,b)=>{
  return +b.querySelector("."+type+" input").value -
         +a.querySelector("."+type+" input").value;
 });

 rows.forEach((r,i)=>{
  r.cells[0].innerHTML=`<span class="rank">${i+1}</span>`;
  r.className="";
  if(i<5) r.classList.add("top"+(i+1));

  const name=r.querySelector(".name input").value;
  const old=yesterday.findIndex(x=>x.name===name);
  const d=r.cells[1];

  if(old===-1){d.textContent="ğŸ†•";d.className="delta same";}
  else if(old>i){d.textContent="ğŸŸ¢â¬†";d.className="delta up";}
  else if(old<i){d.textContent="ğŸ”´â¬‡";d.className="delta down";}
  else{d.textContent="â–";d.className="delta same";}

  const p=r.querySelector(".performance input");
  const v=+p.value;
  p.classList.toggle("pos",v>0);
  p.classList.toggle("neg",v<0);

  tbody.appendChild(r);
 });
}

function updateRewards(){
 const mode=rewardMode.value;
 const percent=+rewardPercent.value||0;
 const topN=+rewardTopN.value||0;
 document.querySelectorAll("tbody tr").forEach((r,i)=>{
  const reward=r.querySelector(".reward input");
  const perf=+r.querySelector(".performance input").value;
  if(i<topN){
    if(mode==="percent") reward.value=Math.round(perf*percent/100);
    reward.readOnly=!(isUnlocked&&mode==="manual");
  }else{
    reward.value=0;
    reward.readOnly=true;
  }
 });
}

function replaceInputsForCapture(){
 document.querySelectorAll(".input-cell").forEach(input=>{
   const span=document.createElement("span");
   span.textContent=input.value;
   span.style.display="inline-block";
   span.style.minWidth="40px";
   span.style.font=getComputedStyle(input).font;
   span.style.fontWeight=getComputedStyle(input).fontWeight;

   /* âœ… å…³é”®ï¼šå¤åˆ¶æ­£è´Ÿé¢œè‰² */
   if(input.classList.contains("pos")){
     span.style.color="#16a34a"; // ç»¿è‰²
     span.style.fontWeight="700";
   }
   if(input.classList.contains("neg")){
     span.style.color="#dc2626"; // çº¢è‰²
     span.style.fontWeight="700";
   }

   span.className="capture-span";
   input.after(span);
   input.style.display="none";
 });
}


function restoreInputs(){
 document.querySelectorAll(".capture-span").forEach(s=>s.remove());
 document.querySelectorAll(".input-cell").forEach(i=>i.style.display="inline-block");
}

function showWatermark(){
 wmDate.textContent=new Date().toISOString().slice(0,10);
 watermark.style.display="block";
}
function hideWatermark(){watermark.style.display="none";}

function downloadCanvas(canvas,filename){
 canvas.toBlob(blob=>{
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
 });
}

function capturePage(){
 toggleView();
 showWatermark();
 replaceInputsForCapture();
 setTimeout(async ()=>{
  const c=await html2canvas(captureArea,{scale:2,backgroundColor:"#fff"});
  downloadCanvas(c,"å¥–åŠ±æ’å.png");
  restoreInputs();
  hideWatermark();
  toggleView();
 },300);
}

async function captureAll(){
 const original=rankType.value;
 const list=[
  {v:"performance",n:"ä¸šç»©"},
  {v:"push",n:"æ¨é€"},
  {v:"first",n:"é¦–å­˜"}
 ];
 for(const x of list){
  rankType.value=x.v;
  updateRanking();updateRewards();
  await new Promise(r=>setTimeout(r,300));
  showWatermark();
  replaceInputsForCapture();
  const c=await html2canvas(captureArea,{scale:2,backgroundColor:"#fff"});
  downloadCanvas(c,`å¥–åŠ±æ’å-${x.n}.png`);
  restoreInputs();
  hideWatermark();
 }
 rankType.value=original;
 updateRanking();updateRewards();
}

function toggleView(){controlPanel.classList.toggle("hide");}
function toggleDark(){document.body.classList.toggle("dark");}

function unlockEdit(){
 isUnlocked=true;
 document.querySelectorAll(".input-cell").forEach(i=>i.removeAttribute("readonly"));
 document.querySelectorAll(".action-btn").forEach(b=>b.style.display="inline-block");
 lockBtn.style.display="inline-block";
}
function lockEdit(){
 isUnlocked=false;
 document.querySelectorAll(".input-cell").forEach(i=>i.setAttribute("readonly",true));
 document.querySelectorAll(".action-btn").forEach(b=>b.style.display="none");
 lockBtn.style.display="none";
 saveData();
}

function addPerson(){
 if(!isUnlocked)return alert("è¯·å…ˆç¼–è¾‘");
 const n=prompt("å§“å");
 if(!n)return;
 const d=loadData();
 d.push({name:n,push:0,first:0,performance:0,reward:0});
 saveData();
 renderTable(d);
}

function deleteRow(b){
 if(!isUnlocked)return;
 b.closest("tr").remove();
 saveData();
 updateRanking();
 updateRewards();
}

renderTable(loadData());
</script>

</body>
</html>
