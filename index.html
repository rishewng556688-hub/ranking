<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å¥–åŠ±æ’åç³»ç»Ÿ</title>
<style>
:root{--bg:#f4f6f9;--card:#fff;--primary:#2563eb;--danger:#dc2626;--border:#e5e7eb;--text:#1f2937;--muted:#6b7280;}
body{margin:0;padding:30px;background:var(--bg);font-family:"Segoe UI","PingFang SC","Microsoft YaHei",sans-serif;color:var(--text);}
h2{text-align:center;margin-bottom:20px;font-weight:600;}
.card{max-width:1100px;margin:auto;background:var(--card);border-radius:14px;padding:20px;box-shadow:0 10px 25px rgba(0,0,0,.06);overflow-x:auto;}
.controls{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:15px;}
select,button{padding:7px 14px;border-radius:10px;border:1px solid #e5e7eb;}
.btn-primary{background:var(--primary);color:#fff;border:none;}
.btn-secondary{background:#e5e7eb;border:none;}
.btn-danger{background:var(--danger);color:#fff;border:none;}
table{width:100%;border-collapse:collapse;table-layout:auto;min-width:600px;}
th,td{padding:12px;border-bottom:1px solid var(--border);text-align:center;white-space:normal;word-break:keep-all;}
th{background:#f9fafb;color:#1f2937;font-weight:600;max-width:200px;}
.editable[contenteditable="true"]{background:#fff7cc;outline:1px dashed #f59e0b;}
.top1{background:#fff7cc;}
.top2{background:#f1f5f9;}
.top3{background:#fef3c7;}
</style>
</head>
<body>
<h2>ğŸ† å¥–åŠ±æ’åç³»ç»Ÿ</h2>
<div class="card">
  <div class="controls">
    <div>æ’åä¾æ® / Ranking byï¼š
      <select id="rankType" onchange="updateRanking()">
        <option value="performance">ä¸šç»© / Total Money</option>
        <option value="push">æ¨é€ / Clients Push</option>
        <option value="first">é¦–å­˜ / First Deposit</option>
      </select>
    </div>
    <div>
      <button class="btn-secondary" onclick="unlockEdit()">ğŸ”“ è§£é”ç¼–è¾‘</button>
      <button class="btn-primary" onclick="saveToGitHub()">â˜ï¸ ä¿å­˜åˆ°äº‘ç«¯</button>
      <button class="btn-primary" onclick="addPerson()">â• æ·»åŠ äººå‘˜</button>
    </div>
  </div>
  <table id="table">
    <thead>
      <tr>
        <th>æ’å / Ranking</th>
        <th>å§“å / Name</th>
        <th>æ¨é€ / Clients Push</th>
        <th>é¦–å­˜ / First Deposit</th>
        <th>ä¸šç»© / Total Money</th>
        <th>æ“ä½œ / Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const EDIT_PASSWORD  = "qwe556688.";  // ç½‘é¡µç¼–è¾‘å¯†ç 
const CLOUD_PASSWORD = "qwe556688.";  // äº‘ç«¯ä¿å­˜å¯†ç 
const GITHUB_USER    = "rishewng556688-hub";
const REPO_NAME      = "ranking";
const FILE_PATH      = "data.json";
const BRANCH         = "main";
const GITHUB_TOKEN   = "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"; // â† åœ¨æœ¬åœ°æ›¿æ¢æˆä½ çš„ Token

let data = [];
let isUnlocked = false;

// åŠ è½½ data.json
function loadData(){
  fetch("data.json?t=" + Date.now())
    .then(r => r.json())
    .then(d => { data = d; render(); })
    .catch(err => { console.log("è¯»å– data.json å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®", err); data = [{name:"å¼ ä¸‰",push:120,first:50,performance:300},{name:"æå››",push:90,first:40,performance:250}]; render(); });
}
loadData();

// è§£é”ç¼–è¾‘
function unlockEdit(){
  if(prompt("è¯·è¾“å…¥ç¼–è¾‘å¯†ç ï¼š")!==EDIT_PASSWORD){alert("å¯†ç é”™è¯¯"); return;}
  isUnlocked=true;
  document.querySelectorAll(".editable").forEach(e=>e.contentEditable="true");
  alert("å·²è¿›å…¥ç¼–è¾‘æ¨¡å¼");
}

// æ¸²æŸ“è¡¨æ ¼
function render(){
  const tbody=document.querySelector("tbody");
  tbody.innerHTML="";
  data.forEach(d=>{
    const tr=tbody.insertRow();
    tr.innerHTML=`
      <td></td>
      <td class="editable name">${d.name}</td>
      <td class="editable push">${d.push}</td>
      <td class="editable first">${d.first}</td>
      <td class="editable performance">${d.performance}</td>
      <td><button class="btn-danger" onclick="del(this)">åˆ é™¤</button></td>
    `;
    tr.querySelectorAll(".editable").forEach(td=>{
      td.contentEditable=false;
      td.oninput=()=>{
        if(!td.classList.contains("name")) td.innerText = td.innerText.replace(/\D/g,"");
        sync();
      };
    });
  });
  updateRanking();
}

// åŒæ­¥è¡¨æ ¼åˆ° data æ•°ç»„
function sync(){
  data=[...document.querySelectorAll("tbody tr")].map(r=>({
    name:r.querySelector(".name").innerText,
    push:+r.querySelector(".push").innerText,
    first:+r.querySelector(".first").innerText,
    performance:+r.querySelector(".performance").innerText
  }));
  updateRanking();
}

// æ’åæ›´æ–°
function updateRanking(){
  const type=document.getElementById("rankType").value;
  data.sort((a,b)=>b[type]-a[type]);
  const rows=[...document.querySelectorAll("tbody tr")];
  rows.forEach((r,i)=>{
    r.cells[0].innerText=i+1;
    r.className=i===0?"top1":i===1?"top2":i===2?"top3":"";
  });
}

// æ·»åŠ äººå‘˜
function addPerson(){
  if(!isUnlocked){alert("è¯·å…ˆè§£é”");return;}
  data.push({name:"æ–°æˆå‘˜",push:0,first:0,performance:0});
  render();
}

// åˆ é™¤äººå‘˜
function del(btn){
  if(!isUnlocked){alert("è¯·å…ˆè§£é”");return;}
  btn.closest("tr").remove();
  sync();
}

// ä¿å­˜åˆ° GitHub
async function saveToGitHub(){
  if(!isUnlocked){alert("è¯·å…ˆè§£é”");return;}
  if(prompt("è¯·è¾“å…¥äº‘ç«¯ä¿å­˜å¯†ç ï¼š")!==CLOUD_PASSWORD){alert("äº‘ç«¯å¯†ç é”™è¯¯");return;}
  sync();

  const api = `https://api.github.com/repos/${GITHUB_USER}/${REPO_NAME}/contents/${FILE_PATH}`;

  // è·å–æ–‡ä»¶ä¿¡æ¯
  let file;
  try{
    const res = await fetch(api, {headers: {"Authorization":`token ${GITHUB_TOKEN}`}});
    file = await res.json();
  } catch(e){ alert("è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥"); console.log(e); return; }

  const content = btoa(unescape(encodeURIComponent(JSON.stringify(data,null,2))));
  let body;
  if(file.sha){ // æ–‡ä»¶å­˜åœ¨
    body = {message:"Update ranking data", content, sha:file.sha, branch:BRANCH};
  } else { // æ–‡ä»¶ä¸å­˜åœ¨
    body = {message:"Create ranking data", content, branch:BRANCH};
  }

  try{
    const res2 = await fetch(api, {
      method:"PUT",
      headers:{"Authorization":`token ${GITHUB_TOKEN}`, "Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    const result = await res2.json();
    console.log(result);
    if(result.commit){
      alert("âœ… å·²æˆåŠŸä¿å­˜åˆ°äº‘ç«¯ï¼Œé¡µé¢å°†è‡ªåŠ¨åˆ·æ–°æ˜¾ç¤ºæœ€æ–°æ•°æ®");
      location.reload();
    } else {
      alert("âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Token å’Œæƒé™");
    }
  } catch(e){ alert("âŒ ä¿å­˜å¤±è´¥ï¼Œç½‘ç»œæˆ–æƒé™é—®é¢˜"); console.log(e);}
}
</script>
</body>
</html>
