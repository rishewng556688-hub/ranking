<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å¥–åŠ±æ’åç³»ç»Ÿ</title>
<style>
:root{
  --bg:#f4f6f9; --card:#ffffff; --primary:#2563eb;
  --danger:#dc2626; --border:#e5e7eb; --text:#1f2937; --muted:#6b7280;
}
body.dark{
  --bg:#0f172a; --card:#020617; --text:#e5e7eb;
  --muted:#94a3b8; --border:#1e293b; --primary:#38bdf8;
}
body{
  margin:0;padding:30px;background:var(--bg);
  font-family:"Segoe UI","PingFang SC","Microsoft YaHei",sans-serif;
  color:var(--text);
}
h2{text-align:center;margin-bottom:20px;}
.card{
  max-width:1200px;margin:auto;background:var(--card);
  border-radius:14px;padding:20px;
  box-shadow:0 6px 18px rgba(0,0,0,.05);
}
.controls{
  display:flex;justify-content:space-between;
  flex-wrap:wrap;gap:10px;margin-bottom:15px;
}
.controls-left{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
select,input,button{
  padding:6px 10px;border-radius:8px;
  border:1px solid var(--border);cursor:pointer;
}
button{border:none;}
.btn-primary{background:var(--primary);color:#fff;}
.btn-secondary{background:#e5e7eb;}
.btn-danger{background:#fee2e2;color:#b91c1c;}
table{width:100%;border-collapse:collapse;}
th,td{
  padding:10px 12px;border-bottom:1px solid var(--border);
  text-align:center;
}
thead th{
  position:sticky;top:0;background:#f9fafb;
  color:var(--muted);font-weight:500;
}
tr:hover{background:#f9fafb;}
.top1{background:linear-gradient(90deg,#fff7cc,#fff);}
.top2{background:linear-gradient(90deg,#f1f5f9,#fff);}
.top3{background:linear-gradient(90deg,#fef3c7,#fff);}
.top4,.top5{background:linear-gradient(90deg,#eef2ff,#fff);}
.rank{font-weight:600;font-size:16px;}
.top1 .rank::before{content:"ğŸ¥‡ ";}
.top2 .rank::before{content:"ğŸ¥ˆ ";}
.top3 .rank::before{content:"ğŸ¥‰ ";}
.top4 .rank::before,.top5 .rank::before{content:"â­ ";}
.delta.up{color:#16a34a;font-weight:bold;}
.delta.down{color:#dc2626;font-weight:bold;}
.delta.same{color:#6b7280;}
.editable{padding:2px 6px;border-radius:6px;}
.editable[contenteditable="true"]{
  background:#fff7cc;outline:1px dashed #f59e0b;
}
tr.editing{background:#eef2ff !important;}
.action-btn{
  padding:5px 10px;font-size:12px;
  opacity:0;transition:.2s;
}
tr:hover .action-btn{opacity:1;}
.zero{color:#6b7280;}
.hide{display:none;}

/* ===== ä¸šç»©æ­£è´Ÿæ˜¾ç¤º ===== */
.performance.pos{color:#16a34a;font-weight:700;}
.performance.neg{color:#dc2626;font-weight:700;}
.performance.zero{color:#6b7280;}
</style>
</head>
<body>

<h2>ğŸ† å¥–åŠ±æ’åç³»ç»Ÿ / Reward Ranking System</h2>

<div class="card" id="captureArea">
  <div class="controls" id="controlPanel">
    <div class="controls-left">
      æ’åä¾æ®ï¼š
      <select id="rankType" onchange="updateRanking(); updateRewards(); saveData();">
        <option value="performance">ä¸šç»© / Total Money</option>
        <option value="push">æ¨é€ / Clients Push</option>
        <option value="first">é¦–å­˜ / First Deposit</option>
      </select>
      å¥–åŠ±æ¨¡å¼ï¼š
      <select id="rewardMode" onchange="updateRewards(); saveData();">
        <option value="manual">æ‰‹åŠ¨</option>
        <option value="percent">æŒ‰ä¸šç»©%</option>
      </select>
      ç™¾åˆ†æ¯”ï¼š
      <input id="rewardPercent" type="number" value="5" style="width:60px"
             onchange="updateRewards(); saveData();">%
      å¥–åŠ±åæ¬¡ï¼šå‰
      <input id="rewardTopN" type="number" value="3" min="1" style="width:60px"
             onchange="updateRewards(); saveData();"> å
    </div>
    <div>
      <button class="btn-secondary" onclick="unlockEdit()">ğŸ”“ ç¼–è¾‘</button>
      <button class="btn-primary" id="lockBtn" onclick="lockEdit()" style="display:none;">ğŸ”’ é”å®š</button>
      <button class="btn-primary" onclick="addPerson()">â• æ·»åŠ </button>
      <button class="btn-primary" onclick="toggleView()">ğŸ‘ å±•ç¤ºæ¨¡å¼</button>
      <button class="btn-primary" onclick="toggleDark()">ğŸŒ™ å¤œé—´</button>
      <button class="btn-primary" onclick="capturePage()">ğŸ“¸ æˆªå›¾</button>
      <button class="btn-primary" onclick="captureAll()">ğŸ“¸ å¯¼å‡ºä¸‰ç§æ’å</button>
    </div>
  </div>

  <table id="rankingTable">
    <thead>
      <tr>
        <th>æ’å</th>
        <th>å˜åŒ–</th>
        <th>å§“å</th>
        <th>æ¨é€</th>
        <th>é¦–å­˜</th>
        <th>ä¸šç»©</th>
        <th>å¥–åŠ±é‡‘é¢</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
const STORAGE_KEY="ranking_system_data";
const LAST_KEY="ranking_system_yesterday";
let isUnlocked=false;

const defaultData=[
  {name:"å¼ ä¸‰",push:120,first:50,performance:300,reward:0},
  {name:"æå››",push:90,first:40,performance:250,reward:0},
  {name:"ç‹äº”",push:80,first:35,performance:200,reward:0},
  {name:"èµµå…­",push:70,first:30,performance:180,reward:0},
  {name:"å­™ä¸ƒ",push:60,first:25,performance:160,reward:0}
];

function loadData(){
  return JSON.parse(localStorage.getItem(STORAGE_KEY))||defaultData;
}

function saveData(){
  const data=[];
  document.querySelectorAll("#rankingTable tbody tr").forEach(r=>{
    data.push({
      name:r.querySelector(".name").innerText,
      push:+r.querySelector(".push").innerText,
      first:+r.querySelector(".first").innerText,
      performance:+r.querySelector(".performance").innerText,
      reward:+r.querySelector(".reward").innerText
    });
  });
  localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
}

function renderTable(data){
  const tbody=document.querySelector("#rankingTable tbody");
  tbody.innerHTML="";
  data.forEach(d=>{
    const tr=tbody.insertRow();
    tr.innerHTML=`
      <td></td>
      <td class="delta"></td>
      <td class="editable name">${d.name}</td>
      <td class="editable push">${d.push}</td>
      <td class="editable first">${d.first}</td>
      <td class="editable performance">${d.performance}</td>
      <td class="editable reward">${d.reward}</td>
      <td><button class="btn-danger action-btn" onclick="deleteRow(this)">åˆ é™¤</button></td>
    `;
    tr.querySelectorAll(".editable").forEach(el=>{
      el.contentEditable=false;
      el.addEventListener("focus",()=>tr.classList.add("editing"));
      el.addEventListener("blur",()=>{
        tr.classList.remove("editing");
        if(!el.classList.contains("name")){
          let raw=el.innerText.replace(/[^\d\-]/g,"");
          let val=parseInt(raw,10);
          if(isNaN(val)) val=0;
          if(!el.classList.contains("performance") && val<0) val=0;
          el.innerText=val;
        }
        updateRanking();
        updateRewards();
        saveData();
      });
    });
  });
  updateRanking();
  updateRewards();
}

function unlockEdit(){
  isUnlocked=true;
  document.querySelectorAll(".editable").forEach(e=>e.contentEditable=true);
  document.getElementById("lockBtn").style.display="inline-block";
}
function lockEdit(){
  isUnlocked=false;
  document.querySelectorAll(".editable").forEach(e=>e.contentEditable=false);
  document.getElementById("lockBtn").style.display="none";
  saveData();
}

function addPerson(){
  if(!isUnlocked) return alert("è¯·å…ˆç¼–è¾‘");
  const name=prompt("è¯·è¾“å…¥å§“å");
  if(!name) return;
  const data=loadData();
  data.push({name,push:0,first:0,performance:0,reward:0});
  saveData();renderTable(data);
}
function deleteRow(btn){
  if(!isUnlocked) return alert("è¯·å…ˆç¼–è¾‘");
  if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
  btn.closest("tr").remove();
  saveData();updateRanking();updateRewards();
}

function saveYesterdayDaily(){
  const today=new Date().toLocaleDateString();
  if(localStorage.getItem("ranking_last_date")!==today){
    const snap=[];
    document.querySelectorAll("#rankingTable tbody tr").forEach(r=>{
      snap.push({
        name:r.querySelector(".name").innerText,
        push:+r.querySelector(".push").innerText,
        first:+r.querySelector(".first").innerText,
        performance:+r.querySelector(".performance").innerText
      });
    });
    localStorage.setItem(LAST_KEY,JSON.stringify(snap));
    localStorage.setItem("ranking_last_date",today);
  }
}

function updateRanking(){
  const tbody=document.querySelector("#rankingTable tbody");
  const rows=[...tbody.rows];
  const type=document.getElementById("rankType").value;
  const yesterday=JSON.parse(localStorage.getItem(LAST_KEY)||"[]");

  rows.sort((a,b)=>{
    const diff=
      Number(b.querySelector("."+type).innerText)-
      Number(a.querySelector("."+type).innerText);
    if(diff!==0) return diff;
    return a.querySelector(".name").innerText.localeCompare(
      b.querySelector(".name").innerText
    );
  });

  rows.forEach((r,i)=>{
    r.cells[0].innerHTML=`<span class="rank">${i+1}</span>`;
    r.className="";
    if(i===0) r.classList.add("top1");
    else if(i===1) r.classList.add("top2");
    else if(i===2) r.classList.add("top3");
    else if(i===3) r.classList.add("top4");
    else if(i===4) r.classList.add("top5");

    const name=r.querySelector(".name").innerText;
    const oldIndex=yesterday.findIndex(x=>x.name===name);
    const delta=r.cells[1];
    if(oldIndex===-1){delta.textContent="ğŸ†•";delta.className="delta same";}
    else if(oldIndex>i){delta.textContent="ğŸŸ¢â¬†";delta.className="delta up";}
    else if(oldIndex<i){delta.textContent="ğŸ”´â¬‡";delta.className="delta down";}
    else{delta.textContent="â–";delta.className="delta same";}

    const perf=r.querySelector(".performance");
    const v=+perf.innerText;
    perf.classList.remove("pos","neg","zero");
    if(v>0) perf.classList.add("pos");
    else if(v<0) perf.classList.add("neg");
    else perf.classList.add("zero");

    tbody.appendChild(r);
  });
}

function updateRewards(){
  const mode=document.getElementById("rewardMode").value;
  const percent=+document.getElementById("rewardPercent").value||0;
  const topN=+document.getElementById("rewardTopN").value||0;
  document.querySelectorAll("#rankingTable tbody tr").forEach((r,i)=>{
    const reward=r.querySelector(".reward");
    const perf=+r.querySelector(".performance").innerText||0;
    if(i<topN){
      reward.innerText=(mode==="percent")?Math.round(perf*percent/100):reward.innerText;
      reward.contentEditable=isUnlocked && mode==="manual";
      reward.classList.remove("zero");
    }else{
      reward.innerText="0";
      reward.contentEditable=false;
      reward.classList.add("zero");
    }
  });
}

function toggleView(){document.getElementById("controlPanel").classList.toggle("hide");}
function toggleDark(){document.body.classList.toggle("dark");}

function capturePage(){
  toggleView();
  setTimeout(()=>{
    html2canvas(document.getElementById("captureArea"),{scale:2,backgroundColor:"#fff"})
    .then(c=>{
      const a=document.createElement("a");
      a.download="å¥–åŠ±æ’åæˆªå›¾.png";
      a.href=c.toDataURL();
      a.click();
      toggleView();
    });
  },200);
}

async function captureAll(){
  const select=document.getElementById("rankType");
  const original=select.value;
  const list=[
    {value:"performance",name:"ä¸šç»©"},
    {value:"push",name:"æ¨é€"},
    {value:"first",name:"é¦–å­˜"}
  ];
  for(const cfg of list){
    select.value=cfg.value;
    updateRanking();updateRewards();
    await new Promise(r=>setTimeout(r,300));
    const canvas=await html2canvas(
      document.getElementById("captureArea"),
      {scale:2,backgroundColor:"#fff"}
    );
    const a=document.createElement("a");
    a.download=`å¥–åŠ±æ’å-${cfg.name}.png`;
    a.href=canvas.toDataURL();
    a.click();
  }
  select.value=original;
  updateRanking();updateRewards();
}

renderTable(loadData());
saveYesterdayDaily();
</script>
</body>
</html>
